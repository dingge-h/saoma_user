(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/home-page/page"],{"0887":function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=a(n("a34a")),o=n("ce5f"),s=n("81d6"),r=n("ef7b");function a(t){return t&&t.__esModule?t:{default:t}}function u(t,e,n,i,o,s,r){try{var a=t[s](r),u=a.value}catch(c){return void n(c)}a.done?e(u):Promise.resolve(u).then(i,o)}function c(t){return function(){var e=this,n=arguments;return new Promise((function(i,o){var s=t.apply(e,n);function r(t){u(s,i,o,r,a,"next",t)}function a(t){u(s,i,o,r,a,"throw",t)}r(void 0)}))}}var d=console,h=(d.log,function(){n.e("pages/home-page/components/shopping-cart").then(function(){return resolve(n("c03d"))}.bind(null,n)).catch(n.oe)}),p=function(){n.e("pages/home-page/components/goods-details").then(function(){return resolve(n("f144"))}.bind(null,n)).catch(n.oe)},l=wx.cloud.database(),f=l.command,_=l.collection("order-data"),g=l.collection("dishes-data"),m={components:{Details:p,Cart:h},data:function(){return{itemize:[],trigger:0,goods:[],heightset:[],tophei:0,scroll_into:"",card:!1,shopping_card:[],popupitem:!1,pro_details:{},tmplIds:"a3K7cJTKlm3x3X26mjEe1sW5dIY-OcPLJCvJa33ZGzs",number_people:0}},methods:{itemIze:function(t,e){var n=this;this.trigger=t,this.scroll_into=e,setTimeout((function(){n.scroll_into=""}),200)},scroLl:function(t){var e=t.detail.scrollTop;e>=this.tophei?e>=this.heightset[this.trigger]&&(this.trigger+=1):e<this.heightset[this.trigger-1]&&(this.trigger-=1),this.tophei=e},plus:function(t,e,n,i){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"001",s=i.quantity,r=i.image,a=i.name,u=i.unitprice,c=i.unit,d=i._id,h=i.good_specs,p="001"==o?s+1:s;this.$set(this.goods[t].good_query[e],"quantity",p),this.$set(this.goods[t].good_query[e],"good_specs",h),this.$set(this.goods[t].good_query[e],"unitprice",u);var l=u*p,f=parseFloat(l.toFixed(10)),_={image:r,name:a,good_specs:h,unitprice:u,quantity:p,unit:c,total_price:f,_id:d,cid:n,good_index:e};this.shopping_Cart(_)},reduce:function(t,e,n,i){var o=i.quantity,s=i.image,r=i.name,a=i.unitprice,u=i.unit,c=i._id,d=i.good_specs,h=o-1;this.$set(this.goods[t].good_query[e],"quantity",h);var p=a*h,l=parseFloat(p.toFixed(10)),f={image:s,name:r,good_specs:d,unitprice:a,quantity:h,unit:u,total_price:l,_id:c,cid:n,good_index:e};this.shopping_Cart(f)},shopping_Cart:function(t){if(0==this.shopping_card.length)this.shopping_card.push(t);else{var e=this.shopping_card.findIndex((function(e){return e._id==t._id}));-1==e?this.shopping_card.unshift(t):(this.$set(this.shopping_card[e],"quantity",t.quantity),this.$set(this.shopping_card[e],"total_price",t.total_price),this.$set(this.shopping_card[e],"good_specs",t.good_specs),this.$set(this.shopping_card[e],"unitprice",t.unitprice))}this.qunint_of_goods()},qunint_of_goods:function(){var t=this,e=this.shopping_card,n={};e.forEach((function(t){n[t.cid]?n[t.cid]+=t.quantity:n[t.cid]=t.quantity}));var i=[];for(var o in n)i.push({cid:o,value:n[o]});i.forEach((function(e){var n=t.itemize.findIndex((function(t){return t.cid==e.cid}));t.$set(t.itemize[n],"sele_quantity",e.value)}))},shopping_Cart_add_sub:function(t,e,n,i,o,s){this.$set(this.shopping_card[t],"quantity",e);var r=s*e,a=parseFloat(r.toFixed(10));this.$set(this.shopping_card[t],"total_price",a);var u=this.goods.findIndex((function(t){return t.cid==i}));this.$set(this.goods[u].good_query[o],"quantity",e),this.qunint_of_goods()},empty_data:function(){this.shopping_card=[],this.itemize.forEach((function(t){t.sele_quantity=0})),this.goods.forEach((function(t){t.good_query.forEach((function(t){t.quantity=0}))})),this.pop_Shopping(!1)},popup_item:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;this.popupitem=t,t&&(o.specs.sort((function(t,e){return t.unitprice-e.unitprice})),this.pro_details={index:e,good_index:n,cid:i,itemgood:o})},pop_Shopping:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.card=t},dishEs:function(){var t=this;return c(i.default.mark((function e(){var n;return i.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,wx.cloud.callFunction({name:"dish",data:{}});case 2:n=e.sent,t.itemize=n.result.res_cate,t.goods=n.result.res_dis,t.$nextTick((function(){t.goods_height()}));case 6:case"end":return e.stop()}}),e)})))()},goods_height:function(){var t=this;this.heightset=[];var e=0,n=wx.createSelectorQuery();n.selectAll(".rig-height").boundingClientRect(),n.exec((function(n){n[0].forEach((function(n){e+=n.height,t.heightset.push(e)}))}))},placean_order:function(){var t=this;wx.requestSubscribeMessage({tmplIds:[this.tmplIds],success:function(e){t.sub_database()},fail:function(e){t.sub_database()}})},sub_database:function(){var t=this;return c(i.default.mark((function e(){var n,a,u,d,h,p,l,m,v;return i.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.shopping_card.filter((function(t){return 0!=t.total_price})),a=0,n.forEach((function(t){a+=t.total_price})),u=wx.getStorageSync("table_num"),d=wx.getStorageSync("number_of_diners"),h={table_number:u,number_of_diners:d,order_time:t.$Time().utcOffset(8).format("YYYY-MM-DD HH:mm:ss"),sett_amount:a,order_no:(0,o.Code)(),transac_status:"unsettled",order_receiving:"mis_orders",menu:[{goods_list:n}]},p={goods_list:n},e.prev=7,e.next=10,_.where({table_number:u,transac_status:"unsettled"}).field({_id:!0,sett_amount:!0}).get();case 10:if(l=e.sent,0!=l.data.length){e.next=16;break}return e.next=14,_.add({data:h});case 14:e.next=19;break;case 16:return m=Number(l.data[0].sett_amount)+a,e.next=19,_.doc(l.data[0]._id).update({data:{sett_amount:m,order_receiving:"mis_orders",menu:f.unshift(p)}});case 19:return n.forEach(function(){var t=c(i.default.mark((function t(e){return i.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,g.doc(e._id).update({data:{monthlysale:f.inc(e.quantity)}});case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),v=t.$Time().utcOffset(8).format("YYYY-MM-DD"),e.next=23,(new s.analysis).sameday(v,a);case 23:return t.push_message(),wx.redirectTo({url:"/pages/order-details/details"}),e.next=27,(0,r.yunPrint)(u,d,n,a,h.order_time);case 27:e.next=32;break;case 29:e.prev=29,e.t0=e["catch"](7),wx.showToast({title:"发生错误",icon:"error"});case 32:case"end":return e.stop()}}),e,null,[[7,29]])})))()},push_message:function(){var t=this.goeasy.pubsub;t.publish({channel:"my_channel",message:"小程序端来的",onSuccess:function(){console.log("消息发布成功。")},onFailed:function(t){console.log("发送消息失败")}})},my_order:function(){wx.navigateTo({url:"/pages/my-order/my-order"})}},onLoad:function(){this.number_people=wx.getStorageSync("number_of_diners"),this.dishEs()},onShow:function(){wx.hideHomeButton()},computed:{total_quantity:function(){var t=0;return this.shopping_card.forEach((function(e){t+=e.quantity})),t}}};e.default=m},1453:function(t,e,n){"use strict";(function(t){n("051c");i(n("66fd"));var e=i(n("a4af"));function i(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=n,t(e.default)}).call(this,n("543d")["createPage"])},"2e0e":function(t,e,n){"use strict";n.r(e);var i=n("0887"),o=n.n(i);for(var s in i)"default"!==s&&function(t){n.d(e,t,(function(){return i[t]}))}(s);e["default"]=o.a},4162:function(t,e,n){"use strict";var i=n("4897"),o=n.n(i);o.a},4897:function(t,e,n){},"4b52":function(t,e,n){"use strict";var i;n.d(e,"b",(function(){return o})),n.d(e,"c",(function(){return s})),n.d(e,"a",(function(){return i}));var o=function(){var t=this,e=t.$createElement;t._self._c;t._isMounted||(t.e0=function(e){e.stopPropagation(),0!=t.total_quantity&&t.placean_order()})},s=[]},a4af:function(t,e,n){"use strict";n.r(e);var i=n("4b52"),o=n("2e0e");for(var s in o)"default"!==s&&function(t){n.d(e,t,(function(){return o[t]}))}(s);n("4162");var r,a=n("f0c5"),u=Object(a["a"])(o["default"],i["b"],i["c"],!1,null,"7ae4c62b",null,!1,i["a"],r);e["default"]=u.exports}},[["1453","common/runtime","common/vendor"]]]);